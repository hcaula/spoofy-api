#!/usr/bin/env node

process.env.ENV_NODE = "production";

let start = Date.now();

const winston = require('winston');

require('../app/models/user')();
require('../app/models/track')();
require('../app/models/play')();

const configWinston = require('../config/winston').configWinston;
const initMongoose = require('../config/database').initMongoose;
const initJob = require('../app/lib/jobs').initJob;

const User = require('mongoose').model('User');

configWinston(function(){
    winston.info("Starting scheduled job.");

    initMongoose(function(error){
        if(error) winston.error(error.stack);
        else {
            User.find({role: "user"}, function(error, users){
                if(error) {
                    winston.error(error.stack);
                    process.exit(0);
                } else {
                    initJob(users, function(error){
                        if(error) {
                            winston.error(error.stack);
                            process.exit(0);
                        } else {
                            let elapsed = (Date.now() - start)/1000;
                            winston.info(`Scheduler job executed successfully in approximately ${elapsed} seconds.`);
                            winston.info('Exiting scheduler execution.');
                            process.exit(0);
                        }
                    });
                }
            });
        }
    });
});
