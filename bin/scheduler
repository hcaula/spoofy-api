#!/usr/bin/env node

/* If no node env is passed, production is used */
process.env.NODE_ENV = (process.env.NODE_ENV || "production");

const start = Date.now();

const winston = require('winston');

require('../app/models/track')();
require('../app/models/play')();
require('../app/models/relation')();
require('../app/models/user')();

const { configWinston } = require('../config/winston');
const { initMongoose } = require('../config/database');
const { initJob } = require('../app/lib/jobs');

const User = require('mongoose').model('User');

configWinston(() => {
    winston.info("Starting scheduled job.");

    initMongoose(error => {
        if(error) winston.error(error.stack);
        else {
            User.find({role: "user"}, (error, users) => {
                if(error) {
                    winston.error(error.stack);
                    process.exit(0);
                } else {
                    initJob(users, (error) => {
                        if(error) {
                            winston.error(error.stack);
                            process.exit(0);
                        } else {
                            const elapsed = (Date.now() - start)/1000;
                            winston.info(`Scheduler job executed successfully in approximately ${elapsed} seconds.`);
                            winston.info('Exiting scheduler execution.');
                            process.exit(0);
                        }
                    });
                }
            });
        }
    });
});
